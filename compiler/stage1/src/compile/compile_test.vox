import "std/testing" as t
import "compile" as c
import "loader" as ld

fn contains(hay: String, needle: String) -> bool {
  if needle.len() == 0 { return true; }
  if hay.len() < needle.len() { return false; }
  let mut i: i32 = 0;
  while i <= hay.len() - needle.len() {
    if hay.slice(i, i + needle.len()) == needle { return true; }
    i = i + 1;
  }
  return false;
}

fn test_compile_main_text_to_c_smoke() -> () {
  let r: c.CompileResult = c.compile_main_text_to_c("fn main() -> i32 { print(\"x\"); return 0; }", true);
  t.assert(r.ok);
}

fn test_compile_files_to_c_smoke_multi_module() -> () {
  let mut fs: Vec[ld.SourceFile] = Vec();
  fs.push(ld.SourceFile { path: "src/a/a.vox", text: "pub fn one() -> i32 { return 1; }" });
  fs.push(ld.SourceFile { path: "src/main.vox", text: "import \"a\" as a\nfn main() -> i32 { return a.one(); }" });

  let r: c.CompileResult = c.compile_files_to_c(fs, true);
  t.assert(r.ok);
  // Expect both main and imported module symbol to appear.
  t.assert(contains(r.c, "vox_fn_mmain"));
  t.assert(contains(r.c, "vox_fn_ma_3a_3aone"));
}
