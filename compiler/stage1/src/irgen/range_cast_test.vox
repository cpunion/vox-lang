import "std/testing" as t
import "typecheck" as tc
import "irgen" as g
import "ir" as ir

fn test_irgen_as_range_i32_emits_range_check() -> () {
  let mut w: tc.World = tc.world();
  w = add_mod(w, "main", "type Tiny = @range(0..=3) i32\nfn main(x: i32) -> i32 { let y: Tiny = x as Tiny; return y as i32; }");
  let r: g.GenResult = g.generate_world(w);
  t.assert(r.ok);
  let s: String = ir.format_program(r.prog);
  t.assert(contains(s, "range_check_i32 0 3"));
}

fn test_irgen_as_i64_to_range_i32_emits_checked_cast_and_range_check() -> () {
  let mut w: tc.World = tc.world();
  w = add_mod(w, "main", "type Tiny = @range(0..=3) i32\nfn main(x: i64) -> i32 { let y: Tiny = x as Tiny; return y as i32; }");
  let r: g.GenResult = g.generate_world(w);
  t.assert(r.ok);
  let s: String = ir.format_program(r.prog);
  t.assert(contains(s, " = i32_from_i64_checked "));
  t.assert(contains(s, "range_check_i32 0 3"));
}

