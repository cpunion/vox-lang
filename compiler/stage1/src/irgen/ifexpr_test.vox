import "std/testing" as t
import "typecheck" as tc
import "irgen" as g
import "ir" as ir

fn contains(hay: String, needle: String) -> bool {
  if needle.len() == 0 { return true; }
  if hay.len() < needle.len() { return false; }
  let mut i: i32 = 0;
  while i <= hay.len() - needle.len() {
    if hay.slice(i, i + needle.len()) == needle { return true; }
    i = i + 1;
  }
  return false;
}

fn test_irgen_ifexpr_with_block_branches_lowers() -> () {
  let mut w: tc.World = tc.world();
  let src: String = "fn main() -> i32 {\n  let x: i32 = if true {\n    let y: i32 = 1;\n    y + 1\n  } else {\n    2\n  };\n  return x;\n}\n";
  w = add_mod(w, "main", src);

  let r: g.GenResult = g.generate_world(w);
  t.assert(r.ok);
  let s: String = ir.format_program(r.prog);
  t.assert(contains(s, "condbr "));
  t.assert(contains(s, "ifexpr_then_"));
  t.assert(contains(s, "ifexpr_end_"));
}

fn test_irgen_ifexpr_both_branches_diverge_lowers() -> () {
  let mut w: tc.World = tc.world();
  let src: String = "fn main(flag: bool) -> i32 {\n  let _x: i32 = if flag {\n    return 7;\n  } else {\n    return 9;\n  };\n  return 0;\n}\n";
  w = add_mod(w, "main", src);

  let r: g.GenResult = g.generate_world(w);
  t.assert(r.ok);
  let s: String = ir.format_program(r.prog);
  t.assert(contains(s, "condbr "));
  t.assert(contains(s, "ifexpr_then_"));
  t.assert(contains(s, "ifexpr_end_"));
}
