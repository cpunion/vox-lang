import "std/testing" as t
import "parse" as p
import "ast" as ast

fn test_parse_range_type_alias_decl() -> () {
  let src: String = "type Tiny = @range(0..=3) i32\nfn main() -> i32 { return 0; }";
  let r: p.ParseResult = p.parse_text(src);
  t.assert(r.err == p.ParseError.None);
  t.assert_eq(r.prog.types.len(), 1);
  let td: ast.TypeAliasDecl = r.prog.types.get(0);
  t.assert_eq(td.name, "Tiny");
  t.assert_eq(td.ty.parts.len(), 3);
  t.assert(td.ty.parts.get(0) == "@range");
  t.assert(td.ty.parts.get(1) == "0");
  t.assert(td.ty.parts.get(2) == "3");
  t.assert_eq(td.ty.args.len(), 1);
  t.assert(td.ty.args.get(0).parts.len() == 1 && td.ty.args.get(0).parts.get(0) == "i32");
}

fn test_parse_range_type_alias_decl_negative_bounds() -> () {
  let src: String = "type Small = @range(-5..=5) i32\nfn main() -> i32 { return 0; }";
  let r: p.ParseResult = p.parse_text(src);
  t.assert(r.err == p.ParseError.None);
  t.assert_eq(r.prog.types.len(), 1);
  let td: ast.TypeAliasDecl = r.prog.types.get(0);
  t.assert_eq(td.name, "Small");
  t.assert_eq(td.ty.parts.len(), 3);
  t.assert(td.ty.parts.get(0) == "@range");
  t.assert(td.ty.parts.get(1) == "-5");
  t.assert(td.ty.parts.get(2) == "5");
  t.assert_eq(td.ty.args.len(), 1);
  t.assert(td.ty.args.get(0).parts.len() == 1 && td.ty.args.get(0).parts.get(0) == "i32");
}

fn test_parse_range_type_alias_decl_u32() -> () {
  let src: String = "type Tiny = @range(0..=3) u32\nfn main() -> i32 { return 0; }";
  let r: p.ParseResult = p.parse_text(src);
  t.assert(r.err == p.ParseError.None);
  t.assert_eq(r.prog.types.len(), 1);
  let td: ast.TypeAliasDecl = r.prog.types.get(0);
  t.assert_eq(td.name, "Tiny");
  t.assert_eq(td.ty.parts.len(), 3);
  t.assert(td.ty.parts.get(0) == "@range");
  t.assert(td.ty.parts.get(1) == "0");
  t.assert(td.ty.parts.get(2) == "3");
  t.assert_eq(td.ty.args.len(), 1);
  t.assert(td.ty.args.get(0).parts.len() == 1 && td.ty.args.get(0).parts.get(0) == "u32");
}

fn test_parse_range_type_alias_decl_i8() -> () {
  let src: String = "type Tiny = @range(0..=3) i8\nfn main() -> i32 { return 0; }";
  let r: p.ParseResult = p.parse_text(src);
  t.assert(r.err == p.ParseError.None);
  t.assert_eq(r.prog.types.len(), 1);
  let td: ast.TypeAliasDecl = r.prog.types.get(0);
  t.assert_eq(td.name, "Tiny");
  t.assert_eq(td.ty.parts.len(), 3);
  t.assert(td.ty.parts.get(0) == "@range");
  t.assert(td.ty.parts.get(1) == "0");
  t.assert(td.ty.parts.get(2) == "3");
  t.assert_eq(td.ty.args.len(), 1);
  t.assert(td.ty.args.get(0).parts.len() == 1 && td.ty.args.get(0).parts.get(0) == "i8");
}

fn test_parse_range_type_alias_decl_u8() -> () {
  let src: String = "type Tiny = @range(0..=3) u8\nfn main() -> i32 { return 0; }";
  let r: p.ParseResult = p.parse_text(src);
  t.assert(r.err == p.ParseError.None);
  t.assert_eq(r.prog.types.len(), 1);
  let td: ast.TypeAliasDecl = r.prog.types.get(0);
  t.assert_eq(td.name, "Tiny");
  t.assert_eq(td.ty.parts.len(), 3);
  t.assert(td.ty.parts.get(0) == "@range");
  t.assert(td.ty.parts.get(1) == "0");
  t.assert(td.ty.parts.get(2) == "3");
  t.assert_eq(td.ty.args.len(), 1);
  t.assert(td.ty.args.get(0).parts.len() == 1 && td.ty.args.get(0).parts.get(0) == "u8");
}

fn test_parse_range_type_alias_decl_u64() -> () {
  let src: String = "type Tiny = @range(0..=3) u64\nfn main() -> i32 { return 0; }";
  let r: p.ParseResult = p.parse_text(src);
  t.assert(r.err == p.ParseError.None);
  t.assert_eq(r.prog.types.len(), 1);
  let td: ast.TypeAliasDecl = r.prog.types.get(0);
  t.assert_eq(td.name, "Tiny");
  t.assert_eq(td.ty.parts.len(), 3);
  t.assert(td.ty.parts.get(0) == "@range");
  t.assert(td.ty.parts.get(1) == "0");
  t.assert(td.ty.parts.get(2) == "3");
  t.assert_eq(td.ty.args.len(), 1);
  t.assert(td.ty.args.get(0).parts.len() == 1 && td.ty.args.get(0).parts.get(0) == "u64");
}

fn test_parse_range_type_alias_decl_isize() -> () {
  let src: String = "type Tiny = @range(-3..=3) isize\nfn main() -> i32 { return 0; }";
  let r: p.ParseResult = p.parse_text(src);
  t.assert(r.err == p.ParseError.None);
  t.assert_eq(r.prog.types.len(), 1);
  let td: ast.TypeAliasDecl = r.prog.types.get(0);
  t.assert_eq(td.name, "Tiny");
  t.assert_eq(td.ty.parts.len(), 3);
  t.assert(td.ty.parts.get(0) == "@range");
  t.assert(td.ty.parts.get(1) == "-3");
  t.assert(td.ty.parts.get(2) == "3");
  t.assert_eq(td.ty.args.len(), 1);
  t.assert(td.ty.args.get(0).parts.len() == 1 && td.ty.args.get(0).parts.get(0) == "isize");
}

fn test_parse_range_type_alias_decl_usize() -> () {
  let src: String = "type Tiny = @range(0..=3) usize\nfn main() -> i32 { return 0; }";
  let r: p.ParseResult = p.parse_text(src);
  t.assert(r.err == p.ParseError.None);
  t.assert_eq(r.prog.types.len(), 1);
  let td: ast.TypeAliasDecl = r.prog.types.get(0);
  t.assert_eq(td.name, "Tiny");
  t.assert_eq(td.ty.parts.len(), 3);
  t.assert(td.ty.parts.get(0) == "@range");
  t.assert(td.ty.parts.get(1) == "0");
  t.assert(td.ty.parts.get(2) == "3");
  t.assert_eq(td.ty.args.len(), 1);
  t.assert(td.ty.args.get(0).parts.len() == 1 && td.ty.args.get(0).parts.get(0) == "usize");
}
