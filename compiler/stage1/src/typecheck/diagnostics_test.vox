import "std/testing" as t
import "parse" as p
import "typecheck" as tc

fn diag_parse_prog(src: String) -> p.ParseResult { return p.parse_text(src); }

fn diag_add_mod(w: tc.World, path: String, src: String) -> tc.World {
  let r: p.ParseResult = diag_parse_prog(src);
  t.assert(r.err == p.ParseError.None);
  return tc.world_add(w, path, r.prog);
}

fn diag_contains(hay: String, needle: String) -> bool {
  if needle.len() == 0 { return true; }
  if hay.len() < needle.len() { return false; }
  let mut i: i32 = 0;
  while i <= hay.len() - needle.len() {
    if hay.slice(i, i + needle.len()) == needle { return true; }
    i = i + 1;
  }
  return false;
}

fn test_typecheck_diag_meta_none() -> () {
  t.assert(tc.tc_error_kind(tc.TcError.None) == tc.diag_kind_none());
  t.assert(tc.tc_error_code(tc.TcError.None) == "");
  t.assert(tc.tc_error_message(tc.TcError.None) == "");
}

fn test_typecheck_diag_meta_type_error() -> () {
  let mut w: tc.World = tc.world();
  let src: String = "fn main() -> i32 { return nope(); }";
  w = diag_add_mod(w, "main", src);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert(!r.ok);
  t.assert(tc.tc_error_kind(r.err) == tc.diag_kind_type());
  t.assert(tc.tc_error_code(r.err) == tc.diag_code_type());
  t.assert(diag_contains(tc.tc_error_message(r.err), "unknown fn"));
  t.assert(diag_contains(tc.tc_error_to_string(r.err), "[E_TYPE_0001]"));
}

fn test_typecheck_diag_meta_import_error() -> () {
  let mut w: tc.World = tc.world();
  let src: String = "import \"missing/pkg\" as m\nfn main() -> i32 { return 0; }";
  w = diag_add_mod(w, "main", src);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert(!r.ok);
  t.assert(tc.tc_error_kind(r.err) == tc.diag_kind_import());
  t.assert(tc.tc_error_code(r.err) == tc.diag_code_import_unknown_module());
  t.assert(diag_contains(tc.tc_error_to_string(r.err), "[E_IMPORT_0002]"));
}

fn test_typecheck_diag_meta_irgen_error_code_suffix() -> () {
  let msg: String = tc.irgen_error("main", "boom");
  t.assert(diag_contains(msg, "irgen error: boom"));
  t.assert(diag_contains(msg, "[E_IRGEN_0001]"));
}
