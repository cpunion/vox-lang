# 标准库

本章用于定义 Vox 标准库的模块边界与最小可用集合。

最小集合（建议）：

- `std::prelude`：基础 trait 与常用类型导出
- `std::string`：`String`、`str`、`StrView`
- `std::fs`：最小文件系统能力（读写文件、枚举源文件；用于 编译器工具链自举）
- `std::process`：最小进程能力（args/exec/exe_path/getenv；用于 编译器工具链自举）
- `std::time`：最小时钟能力（`now_ns`；用于测试与工具链计时）
- `std::sync`：并发原语（`Mutex[T]/Atomic[T]` 泛型 API）
- `std::async`：pull 模型异步核心（`Poll[T]`、`Future`、`Context`、`Waker`、`Runtime`、`pending_wait_with`）
- `std::runtime`：低层 intrinsic 适配边界（标准库内部使用）
- `std::sys`：平台 C API 直连（当前最小集：`read/close/access/mkdir/system/calloc/free`），不引入项目私有 runtime 符号
- `std::collections`：`Vec`、`Map` 等
- `std::io`：输出 + 文件抽象 + Reader/Writer 流 trait
- `std::net`：TCP/UDP 基础封装 + URL/Query/HTTP 文本编解码
- `std::dotenv`：`.env` 读取与键查找（供 CLI/agent 配置加载）
- `std::testing`：测试断言入口（`t.assert*` 兼容层 + 模块化断言扩展）

当前实现落地：

- `std::prelude` 已提供默认 trait：`Eq`、`Ord`、`Show`、`Clone`、`Release`、`Into`（用于 `Result` 的 `?` 传播时 `Err` 转换）。
- 未显式 import 时，函数名会回退到 `std/prelude`；trait 静态调用与 `impl Trait for ...` 也支持回退到 `std/prelude` 的公开 trait。
- `std::string` 已提供 `StrView`（拥有型字符串视图）。
  - 基础 API：`view_all`、`view_range`、`sub`、`len`、`is_empty`、`byte_at`、`to_string`。
  - view-first 子串 API（推荐）：`take_prefix`、`take_suffix`、`drop_prefix`、`drop_suffix`。
  - 匹配/查找 API：
    - `String` 参数版本：`starts_with`、`ends_with`、`contains`、`index_of`、`last_index_of`、`equals`、`compare`
    - `StrView` 参数版本：`starts_with_view`、`ends_with_view`、`contains_view`、`index_of_view`、`last_index_of_view`、`equals_view`、`compare_view`
  - inherent impl（`impl StrView`）已与 free-function 对齐：`len/is_empty/byte_at/sub/take_prefix/take_suffix/drop_prefix/drop_suffix/to_string/starts_with/ends_with/contains/index_of/last_index_of/equals/compare`。
  - 语言层当前不支持裸 `str`（会报错）；请使用 `String`（拥有）或 `&str`/`&'static str`（借用）。同时支持 `&T` / `&mut T` / `&'static T` / `&'static mut T` 语法（借用形状在类型系统/IR 中保留为 `Ref`，`&'a T` 这类命名 lifetime 在 parser 阶段拒绝）。
  - 显式释放基线：`release(s: String) -> String`，返回空字符串并断开当前值（不触发别名 UAF）。该调用必须接收返回值（例如 `s = release(s)`），裸表达式语句会报错；被释放变量后续读取会报 `use of moved value`（除非先重绑定）。
- `std::collections` 已提供 `Slice[T]`（拥有型 `Vec[T]` 视图）。
  - 基础 API：`view_all`、`view_range`、`sub`、`len`、`is_empty`、`get`、`to_vec`。
  - view-first 子切片 API（推荐）：`take_prefix`、`take_suffix`、`drop_prefix`、`drop_suffix`。
  - 查找与匹配 API：`contains`、`index_of`、`last_index_of`、`starts_with`、`ends_with`、`contains_slice`、`index_of_slice`、`last_index_of_slice`（相关 API 需要 `T: Eq`）。
  - 比较 API：`equals`/`equals_vec`（`T: Eq`）、`compare`/`compare_vec`（`T: Ord`）。
  - inherent impl 已对齐：
    - `impl[T] Slice[T]`：`len/is_empty/get/sub/take_prefix/take_suffix/drop_prefix/drop_suffix/to_vec`
    - `impl[T: Eq] Slice[T]`：`index_of/last_index_of/contains`
  - 显式释放基线：`release_vec[T](v: Vec[T]) -> Vec[T]`，返回新的空 `Vec`，不释放共享底层存储（避免别名 UAF）。该调用必须接收返回值；被释放变量后续读取会报 `use of moved value`（除非先重绑定）。
- `std::collections` 还提供最小泛型 `Map[K,V]`（线性实现）：
  - 构造函数：`map[K,V]()`
  - inherent impl（`impl[K: Eq, V] Map[K,V]`）方法：
    - `len`、`is_empty`、`index_of_key`、`contains_key`
    - `get`、`get_or`（缺失键时返回调用方提供的 fallback）
    - `keys`、`values`（按当前存储顺序返回拷贝）
    - `set`（存在则覆盖，不存在则插入）、`remove`、`clear`、`release`（需接收返回值，释放后旧变量读取会报 `use of moved value`）
    - `set_if_absent`（仅在缺失键时插入）
    - `get_or_set`（单次查找完成“读取或插入”，返回 `MapGetOrSetResult[K,V] { map, value, inserted }`）
    - `try_remove_or`（单次查找完成“读取并删除或回退”，返回 `MapTryRemoveResult[K,V] { map, value, removed }`）
  - 当前实现优化：`set` 覆盖路径与 `remove` 路径已改为 `Vec.set/remove` 原地更新，避免旧实现的整表重建拷贝。
  - 其中键比较相关 API 需要 `K: Eq`。
  - 另外提供 `impl[K: Eq + Clone, V: Clone] Clone for Map[K,V]`（深拷贝 keys/vals，不共享底层 Vec 存储）。
  - 另外提供 `impl[K: Eq, V] Release for Map[K,V]`（返回空 `Map`，显式断开当前值）。
- `std::collections` 新增通用容器：
  - `Queue[T]`：FIFO 队列，基于 `Vec` + `head` 指针与惰性 compact；支持 `push`/`push_all`/`front`/`pop`/`pop_n`/`to_vec`/`clear`/`release`。
    - 额外提供 `impl[T: Eq] Queue[T].contains`（并保留 `queue_contains` 兼容入口）。
  - `Set[T: Eq]`：去重集合，基于线性 `Vec[T]`；支持 `add`/`remove`/`contains`/`values`/`clear`/`release`。
    - 额外提供 `add_all`、`contains_all`、`remove_all`、`intersects` 批量能力（`intersects` 走小集合优先扫描路径）。
- `std::fs` / `std::process` 已提供最小工具链内建封装（文件读写、路径存在性、`mkdir -p`、文件枚举、命令执行、参数读取、环境变量读取）。
  - `std::fs` 新增 `Path` 方法式 API：`path(raw)` + `Path.exists/read_to_string/write_string/mkdir_p/walk_files`。
  - `std::fs` 路径 helper（OOP + free-function）：
    - `Path.clean/join/base_name/dir_name/ext/stem/is_abs`
    - `clean/join/base_name/dir_name/ext/stem/is_abs`
  - `std::fs` 仍保留 free-function 入口：`exists/read_to_string/write_string/mkdir_p/walk_files`（内部转发到 `Path`）。
  - `std::fs` 新增虚拟文件系统基线（借鉴 Go `io/fs` 思路）：
    - trait：`FS`（读/存在/枚举）与 `WritableFS`（写/建目录）
    - 实现：`OsFS`（系统文件系统包装）与 `MemFS`（内存文件系统）
    - 泛型 helper：`fs_read_to_string/fs_write_string/fs_exists/fs_walk_files/fs_mkdir_p`
  - `std::process` 新增 `Command` 方法式 API：`command(prog)` + `Command.env/env_remove/clear_env/cwd/arg/args/render/run`。
  - `std::process` 仍保留 free-function 入口：`exec/args/exe_path/getenv`（`exec` 可直接执行 `Command.render()` 结果）。
- `std::time` 已提供 `now_ns() -> i64`（wall-clock 纳秒时间戳，解释器与 C 后端均可用）。
- `std::io` 已提供：`out`、`out_ln`、`fail`。
  - 文件 API：`file(path)` + `File.exists/read_all/write_all/mkdir_p`。
  - 流抽象：`Reader/Writer/Closer/ReadWriter` 与 `BufReader/BufWriter` 基线（后续补充完整 bufio 能力）。
- `std::runtime` 已收缩为编译器基础能力边界：
  - 保留：`intrinsic_abi/has_intrinsic`、`wake_notify/wake_wait/wake_wait_any`、`atomic_i32_*`、`atomic_i64_*`。
  - 已迁出：进程/环境、时间、文件、TCP、mutex 等业务语义入口。
  - 约定：`std` 其它模块不再直接调用 `__*`，统一经 `std::runtime` / `std::os` / `std::time` / `std::sys` 分层转发。
- `std::sys` 已提供最小平台 FFI 绑定：
  - 文件/FD：`read/close/access/mkdir`
  - 进程：`system`
  - 内存：`calloc/free`
  - 约定：
    - `std::sys` 仅声明平台 API 差异与薄封装，不引入 `vox_builtin_*` / `vox_rt_*` 这类项目私有前缀符号。
    - 平台分流统一使用文件级 `@build(...)`，不在标准库生产代码中使用 `@cfg(...)`（`@cfg` 仅保留给编译器语义测试）。
- `std::net` 已提供：
  - 请求对象化入口：
    - `Request/Response/Client` 方法式 API（`new_request/request`、`Request.with_header/with_body/render`、`client().try_send/send/try_get/get`）
    - `response_from_raw` 结构化响应构造与 `Response.status_code/reason/header`
    - 结构化错误入口：`new_request`、`http_roundtrip_checked`、`Client.try_*`（兼容 API 仍保留 panic 语义）
  - 地址/传输抽象：`NetProto`（`Tcp/Udp`）、`SocketAddr`、`parse_socket_uri`、`tcp_addr/udp_addr`。
    - 方法式连接/监听：`SocketAddr.tcp_connect/listen/bind_udp/uri`。
    - 连接生命周期：`NetConn.is_closed/try_send/send/try_recv/recv/try_wait_read/wait_read/try_wait_write/wait_write/try_close/close`。
  - URL/Query：`Url`、`parse_url`、`Url.to_string`、`query_escape`、`build_query`
  - HTTP 文本：`HttpRequest` + `with_header`/`with_body`/`render`，`parse_status`/`parse_status_code`/`header_value`/`response_body`
  - 最小 TCP HTTP：`http_roundtrip` 与 `http_get`（基于 `std::net` 的 `NetConn`）
- `std::dotenv` 已提供：
  - `value(path, key)`：读取单个 `.env` 文件中的键值（支持 `KEY=...` 与 `export KEY=...`）
  - `value_from_paths(paths, key)`：按路径顺序查找首个非空值
- `std::sync` 当前 API 为泛型句柄：`Mutex[T]` / `Atomic[T]`（当前 `T` 由 `SyncScalar` 约束，已覆盖 `i32/i64`）；标准库层句柄类型为 `isize`（按目标指针宽度），内部通过 `std::runtime` 适配到现有 intrinsic。`fetch_add/swap/load/store` 已在解释器与 C 后端对齐。
- `std::testing` 当前实现：
  - 兼容层：`std/testing` 继续导出 `assert/assert_with/fail/assert_eq/assert_ne/assert_lt/assert_le/assert_gt/assert_ge`。
  - 模块化扩展：`std/testing/asserts` 新增断言 helper：
    - `is_true/is_false`
    - `str_contains/str_not_contains/str_starts_with/str_ends_with`
    - `str_empty/str_not_empty`

重要：由于 Vox 的“临时借用”规则，标准库应优先提供“可长期保存的拥有型视图”（例如 `StrView` / `Slice[T]`），并优先使用 view-first API（避免不必要的 `to_string` / `to_vec` 物化）。
