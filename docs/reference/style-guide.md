# Vox 风格指南（项目执行版）

本指南用于统一 Vox 的语言设计、标准库 API 设计、实现与提交流程。后续开发默认按本指南执行。

## 1. 总体原则

1. 语义优先，不为“形式统一”牺牲可读性和稳定性。
2. 功能按“同类一次做完整”推进：语法、类型检查、IR、代码生成、测试、文档同批收尾。
3. 用户体验优先：保持向后兼容，避免无必要破坏式变更。
4. 单主线滚动自举：以当前主编译器持续迭代，不回退旧 stage 路径。

## 2. API 设计风格

### 2.1 OOP 与函数式的边界

仅当类型存在明确 `self` 语义时引入方法：

- 拥有资源句柄、状态或身份（例如 `File`、`NetConn`、`Path`）。
- 需要表达“读/写/关闭/释放”等对象生命周期行为。

不强行 OOP 化：

- 纯无状态能力（例如全局探针、纯工具函数、简单转换函数）保留 free-function。

### 2.2 兼容策略

新增方法式 API 时：

1. 先保留旧 free-function 入口。
2. 旧入口实现为薄包装（wrapper）转发到新方法。
3. 在文档中明确“方法优先，函数兼容”。

### 2.3 借用与 move 语义

方法接收者遵循语义：

- 只读/不消费对象：使用借用接收者（例如 `&T`）。
- 终结行为（如 `close/release`）可使用按值消费。

避免临时值直接传给借用参数；需要位置（place）时先绑定本地变量。

## 3. 语言与实现演进规则

1. 语法扩展必须先明确边界和错误语义，再实现。
2. 不引入“半完成语义”长期停留主线；若暂不可做，明确标记 deferred。
3. 内建能力优先经 `std/runtime`、`std/*` 封装；避免业务层直接依赖 `__*`。
4. 目标平台行为必须文档化，并有至少一条对应回归测试。
5. `builtin/intrinsic` 集合冻结：默认禁止新增；如确需变更，必须同 PR 更新 `scripts/release/frozen-builtins.lock` 并给出设计理由。

### 3.1 Builtin 终局目标（约束）

`vox_builtin_*` runtime 能力的目标是“清零语言内建暴露”，统一下沉到标准库实现（`std` + `ffi` + 平台封装）。

仅允许保留“编译期类型与目标反射”相关 intrinsic：

1. 类型关系（如 `@same_type/@assignable_to/@castable_to/@ordered_with`）。
2. 类型谓词（如 `@is_*` 系列）。
3. 目标反射（`@target_os/@target_arch/@target_ptr_bits`）。
4. 原子语义走 IR 指令模型，不以 runtime builtin 函数暴露。

除此之外（进程/环境/时间/文件路径/唤醒/网络/互斥锁等）一律通过标准库能力实现，不进入 builtin 集合。

## 4. 文档规范

1. `docs/reference/` 放稳定、对用户可见的规范。
2. `docs/internal/` 放实现细节、历史设计和内部计划。
3. 已完成能力不标记“草案”；仅未完成项可标注 deferred/计划中。
4. 文档与代码必须同 PR 更新，禁止“实现先行、文档长期滞后”。

## 5. 测试规范

每个功能至少覆盖以下层级中的相关项：

1. 语法/解析（如适用）。
2. typecheck 语义与错误诊断。
3. compile/ir/codegen 关键路径。
4. std/runtime 行为（如涉及标准库或运行时）。

新增 API 若保留兼容入口，需同时测试：

- 新方法路径；
- 旧函数包装路径。

## 6. 提交流程（强制）

每一项任务按以下流程执行：

1. 新建分支开发。
2. 本地先过格式化和测试。
3. 提交 PR。
4. 处理 review comments（采纳或明确说明不采纳原因）。
5. CI 全绿后合并。
6. 切回 `main` 并 `pull --ff-only`。
7. 再开下一分支进入下一项。

## 7. 本地门禁命令

最小门禁：

```bash
vox run fmt
make fmt-check
make test
```

按功能补充定向测试（`vox test --run='*pattern*'`）。

## 8. 清单与收尾要求

1. 待办项要有稳定编号或明确范围，避免反复重列同一任务。
2. “完成”定义：代码 + 测试 + 文档 + CI。
3. 一项收尾后再进入下一项；不留“半完成尾巴”。
