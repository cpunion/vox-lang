import "std/testing" as t

fn test_target_matrix_cli_parse_windows_mingw_triple_smoke() -> () {
  let tr: CliTargetSpec = parse_cli_target_spec("x86_64-w64-mingw32", "darwin", "arm64");
  t.assert(tr.ok);
  t.assert(tr.os == "windows");
  t.assert(tr.arch == "amd64");
  t.assert(tr.abi == "gnu");
  t.assert(tr.triple == "x86_64-w64-mingw32");
}

fn test_target_matrix_cli_parse_windows_msvc_triple_smoke() -> () {
  let tr: CliTargetSpec = parse_cli_target_spec("x86_64-pc-windows-msvc", "darwin", "arm64");
  t.assert(tr.ok);
  t.assert(tr.os == "windows");
  t.assert(tr.arch == "amd64");
  t.assert(tr.abi == "msvc");
  t.assert(tr.triple == "x86_64-pc-windows-msvc");
}

fn test_target_matrix_cli_parse_linux_x86_triple_smoke() -> () {
  let tr: CliTargetSpec = parse_cli_target_spec("i686-unknown-linux-gnu", "darwin", "arm64");
  t.assert(tr.ok);
  t.assert(tr.os == "linux");
  t.assert(tr.arch == "x86");
  t.assert(tr.triple == "i686-unknown-linux-gnu");
}

fn test_target_matrix_cli_parse_windows_x86_msvc_triple_smoke() -> () {
  let tr: CliTargetSpec = parse_cli_target_spec("i686-pc-windows-msvc", "darwin", "arm64");
  t.assert(tr.ok);
  t.assert(tr.os == "windows");
  t.assert(tr.arch == "x86");
  t.assert(tr.abi == "msvc");
  t.assert(tr.triple == "i686-pc-windows-msvc");
}

fn test_target_matrix_cli_reject_darwin_x86() -> () {
  let tr: CliTargetSpec = parse_cli_target_spec("darwin-x86", "darwin", "arm64");
  t.assert(!tr.ok);
}

fn test_target_matrix_cc_cmdline_windows_msvc_smoke() -> () {
  let cmd: String = cc_cmdline_for_target("windows", "amd64", "windows", "amd64", "x86_64-pc-windows-msvc", "msvc", "out.c", "out.exe");
  t.assert(text_contains(cmd, " /TC "));
  t.assert(text_contains(cmd, " /Fe:out.exe"));
  t.assert(text_contains(cmd, "ws2_32.lib"));
}

fn test_target_matrix_cc_cmdline_windows_mingw_smoke() -> () {
  let cmd: String = cc_cmdline_for_target("linux", "amd64", "windows", "amd64", "x86_64-w64-mingw32", "gnu", "out.c", "out.exe");
  t.assert(text_contains(cmd, "x86_64-w64-mingw32-gcc"));
  t.assert(text_contains(cmd, " -lws2_32"));
}

fn test_target_matrix_cc_cmdline_windows_x86_mingw_smoke() -> () {
  let cmd: String = cc_cmdline_for_target("linux", "amd64", "windows", "x86", "i686-w64-mingw32", "gnu", "out.c", "out.exe");
  t.assert(text_contains(cmd, "i686-w64-mingw32-gcc"));
  t.assert(text_contains(cmd, " -lws2_32"));
}
