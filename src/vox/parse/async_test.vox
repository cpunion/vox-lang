import "std/testing" as t
import "vox/parse" as p
import "vox/ast" as ast

fn ok(e: p.ParseError) -> bool {
  return e == p.ParseError.None;
}

fn test_parse_async_fn_marks_flag_smoke() -> () {
  let r: p.ParseResult = p.parse_text("async fn main() -> i32 { return 0; }");
  t.assert(ok(r.err));
  t.assert_eq(r.prog.funcs.len(), 1);
  let fd: ast.FuncDecl = r.prog.funcs.get(0);
  t.assert(fd.is_async);
  t.assert_eq(fd.name, "main");
}

fn test_parse_await_expr_is_deferred_error() -> () {
  let src: String = "fn main() -> i32 { let x: i32 = await 1; return x; }";
  let r: p.ParseResult = p.parse_text(src);
  t.assert(!ok(r.err));
  let msg: String = p.parse_error_to_string(r.err);
  t.assert(contains(msg, "await expression is deferred"));
}

fn test_parse_async_trait_method_is_deferred_error() -> () {
  let src: String = "trait T { async fn f() -> i32; }";
  let r: p.ParseResult = p.parse_text(src);
  t.assert(!ok(r.err));
  let msg: String = p.parse_error_to_string(r.err);
  t.assert(contains(msg, "async trait method is deferred"));
}
