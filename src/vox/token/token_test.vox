import "std/testing" as t
import "vox/token" as tok

fn test_token_pos_and_position_smoke() -> () {
  let ar: tok.AddFileResult = tok.file_set_add_file_from_text(tok.file_set(), "src/a.vox", "ab\ncd");
  let p3: tok.Pos = tok.file_set_pos(ar.fset, ar.file_idx, tok.off_from_raw(3));

  t.assert(tok.pos_is_valid(p3));
  t.assert_eq(tok.pos_raw(p3), ar.file.base + 3);

  let fo: tok.FileOffsetResult = tok.file_offset(ar.file, p3);
  t.assert(fo.ok);
  t.assert_eq(tok.off_raw(fo.off), 3);

  let pp: tok.Position = tok.file_set_position(ar.fset, p3);
  t.assert_eq(pp.filename, "src/a.vox");
  t.assert_eq(pp.line, 2);
  t.assert_eq(pp.col, 1);
}

fn test_token_no_pos_invalid() -> () {
  let ar: tok.AddFileResult = tok.file_set_add_file_from_text(tok.file_set(), "src/a.vox", "ab");
  let np: tok.Pos = tok.no_pos();

  t.assert(!tok.pos_is_valid(np));

  let fo: tok.FileOffsetResult = tok.file_offset(ar.file, np);
  t.assert(!fo.ok);
  t.assert_eq(tok.off_raw(fo.off), 0);
  t.assert_eq(tok.file_offset_raw(ar.file, np), -1);

  let pp: tok.Position = tok.file_set_position(ar.fset, np);
  t.assert_eq(pp.filename, "");
  t.assert_eq(pp.line, 0);
  t.assert_eq(pp.col, 0);
}
