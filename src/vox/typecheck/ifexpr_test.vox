import "std/testing" as t
import "vox/typecheck" as tc

fn test_typecheck_ifexpr_branch_blocks_with_stmts() -> () {
  let mut w: tc.World = tc.world();
  let src: String = """
    fn main() -> i32 {
      let x: i32 = if true {
        let y: i32 = 1;
        y + 1
      } else {
        2
      };
      return x;
    }
  """;
  w = add_mod(w, "main", src);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert(ok(r));
}

fn test_typecheck_ifexpr_else_if_chain_smoke() -> () {
  let mut w: tc.World = tc.world();
  let src: String = """
    fn sign(x: i32) -> i32 {
      let y: i32 = if x < 0 {
        -1
      } else if x == 0 {
        0
      } else {
        1
      };
      return y;
    }
    fn main() -> i32 { return sign(7); }
  """;
  w = add_mod(w, "main", src);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert(ok(r));
}

fn test_typecheck_ifexpr_branch_without_tail_is_unit() -> () {
  let mut w: tc.World = tc.world();
  let src: String = """
    fn main() -> i32 {
      let x: i32 = if true {
        let y: i32 = 1;
      } else {
        2
      };
      return x;
    }
  """;
  w = add_mod(w, "main", src);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert(!ok(r));
}

fn test_typecheck_ifexpr_branch_return_diverges() -> () {
  let mut w: tc.World = tc.world();
  let src: String = """
    fn main(flag: bool) -> i32 {
      let x: i32 = if flag {
        return 7;
      } else {
        3
      };
      return x;
    }
  """;
  w = add_mod(w, "main", src);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert(ok(r));
}

fn test_typecheck_ifexpr_both_branches_diverge() -> () {
  let mut w: tc.World = tc.world();
  let src: String = """
    fn main(flag: bool) -> i32 {
      let _x: i32 = if flag {
        return 7;
      } else {
        return 9;
      };
      return 0;
    }
  """;
  w = add_mod(w, "main", src);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert(ok(r));
}

fn test_typecheck_ifexpr_branch_break_continue_inside_loop() -> () {
  let mut w: tc.World = tc.world();
  let src: String = """
    fn main() -> i32 {
      let mut i: i32 = 0;
      while i < 10 {
        let _x: i32 = if i > 5 {
          break;
        } else if i < 0 {
          continue;
        } else {
          i
        };
        i = i + 1;
      }
      return i;
    }
  """;
  w = add_mod(w, "main", src);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert(ok(r));
}

fn test_typecheck_ifexpr_break_outside_loop_rejected() -> () {
  let mut w: tc.World = tc.world();
  let src: String = """
    fn main() -> i32 {
      let x: i32 = if true {
        break;
      } else {
        1
      };
      return x;
    }
  """;
  w = add_mod(w, "main", src);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert_with(!ok(r), "expected break-outside-loop error");
  let msg: String = tc.tc_error_to_string(r.err);
  t.assert_with(contains(msg, "break outside loop"), msg);
}

fn test_typecheck_ifexpr_continue_outside_loop_rejected() -> () {
  let mut w: tc.World = tc.world();
  let src: String = """
    fn main() -> i32 {
      let x: i32 = if true {
        continue;
      } else {
        1
      };
      return x;
    }
  """;
  w = add_mod(w, "main", src);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert_with(!ok(r), "expected continue-outside-loop error");
  let msg: String = tc.tc_error_to_string(r.err);
  t.assert_with(contains(msg, "continue outside loop"), msg);
}
