import "std/testing" as t
import "vox/typecheck" as tc

fn test_typecheck_struct_lit_omit_private_field_in_defining_module() -> () {
  let mut w: tc.World = tc.world();
  w = add_mod(w, "main", """
    pub struct S { pub x: i32, y: i32 }
    fn main() -> i32 {
      let _s: S = S { x: 1 };
      return 0;
    }
  """);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert(ok(r));
}

fn test_typecheck_struct_lit_missing_public_field_rejected_even_in_defining_module() -> () {
  let mut w: tc.World = tc.world();
  w = add_mod(w, "main", """
    pub struct S { pub x: i32, y: i32, pub z: i32 }
    fn main() -> i32 {
      let _s: S = S { x: 1 };
      return 0;
    }
  """);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert_with(!ok(r), "expected missing field error");
  let msg: String = tc.tc_error_to_string(r.err);
  t.assert_with(contains(msg, "missing field in struct literal"), msg);
  t.assert_with(contains(msg, "z"), msg);
}

fn test_typecheck_struct_lit_private_field_required_outside_module() -> () {
  let mut w: tc.World = tc.world();
  w = add_mod(w, "m", "pub struct S { pub x: i32, y: i32 }");
  w = add_mod(w, "main", """
    import "m" as m
    fn main() -> i32 {
      let _s: m.S = m.S { x: 1 };
      return 0;
    }
  """);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert_with(!ok(r), "expected missing field error");
  let msg: String = tc.tc_error_to_string(r.err);
  t.assert_with(contains(msg, "missing field in struct literal"), msg);
  t.assert_with(contains(msg, "y"), msg);
}

fn test_typecheck_struct_lit_duplicate_field_rejected() -> () {
  let mut w: tc.World = tc.world();
  w = add_mod(w, "main", """
    pub struct S { pub x: i32, y: i32 }
    fn main() -> i32 {
      let _s: S = S { x: 1, x: 2, y: 3 };
      return 0;
    }
  """);
  let r: tc.TcResult = tc.typecheck_world(w);
  t.assert_with(!ok(r), "expected duplicate field error");
  let msg: String = tc.tc_error_to_string(r.err);
  t.assert_with(contains(msg, "duplicate field in struct literal"), msg);
  t.assert_with(contains(msg, "x"), msg);
}
