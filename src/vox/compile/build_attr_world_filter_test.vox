import "std/testing" as t
import "vox/compile" as c
import "vox/loader" as ld
import "vox/codegen" as cg

fn emit_opts() -> cg.EmitOptions {
  return cg.EmitOptions {
    emit_driver_main: true,
    driver_main_kind: cg.DriverMainKind.User,
    emit_test_main: false,
    test_funcs: Vec(),
  };
}

fn test_compile_target_build_attr_filters_out_non_matching_files_windows() -> () {
  let mut fs: Vec[ld.SourceFile] = Vec();
  fs.push(ld.SourceFile {
    path: "src/os_linux.vox",
    text: """
      @build(linux)
      fn only_linux() -> i32 { return 7; }
    """,
  });
  fs.push(ld.SourceFile {
    path: "src/main.vox",
    text: "fn main() -> i32 { return 1; }",
  });

  let r: c.CompileResult = c.compile_files_to_c_for_target(
    fs,
    emit_opts(),
    64,
    "windows",
    "amd64",
  );
  t.assert_with(r.ok, r.err);
}

fn test_compile_target_build_attr_filters_out_non_matching_files_linux() -> () {
  let mut fs: Vec[ld.SourceFile] = Vec();
  fs.push(ld.SourceFile {
    path: "src/os_windows.vox",
    text: """
      @build(windows)
      fn only_windows() -> i32 { return 9; }
    """,
  });
  fs.push(ld.SourceFile {
    path: "src/main.vox",
    text: "fn main() -> i32 { return 2; }",
  });

  let r: c.CompileResult = c.compile_files_to_c_for_target(
    fs,
    emit_opts(),
    64,
    "linux",
    "amd64",
  );
  t.assert_with(r.ok, r.err);
}
