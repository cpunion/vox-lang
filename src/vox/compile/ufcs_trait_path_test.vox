import "std/testing" as t
import "vox/compile" as c
import "vox/loader" as ld
import "vox/codegen" as cg

fn test_compile_ufcs_alias_trait_path_smoke() -> () {
  let mut fs: Vec[ld.SourceFile] = Vec();
  fs.push(ld.SourceFile {
    path: "src/dep/dep.vox",
    text: """
      pub trait Show { fn show(x: Self) -> String; }
      pub struct I { pub v: i32 }
      impl Show for I { fn show(x: I) -> String { return x.v.to_string(); } }
    """,
  });
  fs.push(ld.SourceFile {
    path: "src/main.vox",
    text: """
      import "dep" as d
      fn main() -> i32 {
        let i: d.I = d.I { v: 7 };
        let s: String = d.Show.show(i);
        return s.len();
      }
    """,
  });
  let r: c.CompileResult = c.compile_files_to_c(fs, cg.EmitOptions {
    emit_driver_main: true,
    driver_main_kind: cg.DriverMainKind.User,
    emit_test_main: false,
    test_funcs: Vec(),
  });
  t.assert_with(r.ok, r.err);
}

fn test_compile_ufcs_named_import_trait_path_smoke() -> () {
  let mut fs: Vec[ld.SourceFile] = Vec();
  fs.push(ld.SourceFile {
    path: "src/dep/dep.vox",
    text: """
      pub trait Show { fn show(x: Self) -> String; }
      pub struct I { pub v: i32 }
      impl Show for I { fn show(x: I) -> String { return x.v.to_string(); } }
    """,
  });
  fs.push(ld.SourceFile {
    path: "src/main.vox",
    text: """
      import { Show, I } from "dep"
      fn main() -> i32 {
        let i: I = I { v: 42 };
        let s: String = Show.show(i);
        return s.len();
      }
    """,
  });
  let r: c.CompileResult = c.compile_files_to_c(fs, cg.EmitOptions {
    emit_driver_main: true,
    driver_main_kind: cg.DriverMainKind.User,
    emit_test_main: false,
    test_funcs: Vec(),
  });
  t.assert_with(r.ok, r.err);
}
