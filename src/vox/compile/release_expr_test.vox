import "std/testing" as t
import "vox/compile" as c
import "vox/loader" as ld
import "vox/codegen" as cg

fn test_compile_release_move_if_expr_marks_source_moved() -> () {
  let mut fs: Vec[ld.SourceFile] = Vec();
  fs.push(ld.SourceFile {
    path: "src/std/prelude/prelude.vox",
    text: """
      pub trait Release { fn release(x: Self) -> Self; }
      impl Release for String { fn release(x: String) -> String { return ""; } }
    """,
  });
  fs.push(ld.SourceFile {
    path: "src/std/string/string.vox",
    text: "pub fn release(s: String) -> String { return Release.release(s); }",
  });
  fs.push(ld.SourceFile {
    path: "src/main.vox",
    text: """
      import "std/string" as s
      fn main(flag: bool) -> i32 {
        let mut a: String = "x";
        let _b: String = if flag { s.release(a) } else { "y" };
        return a.len();
      }
    """,
  });

  let r: c.CompileResult = c.compile_files_to_c(fs, cg.EmitOptions {
    emit_driver_main: true,
    driver_main_kind: cg.DriverMainKind.User,
    emit_test_main: false,
    test_funcs: Vec(),
  });
  t.assert(!r.ok);
  t.assert_with(contains(r.err, "use of moved value: a"), r.err);
}

fn test_compile_release_move_block_expr_marks_source_moved() -> () {
  let mut fs: Vec[ld.SourceFile] = Vec();
  fs.push(ld.SourceFile {
    path: "src/std/prelude/prelude.vox",
    text: """
      pub trait Release { fn release(x: Self) -> Self; }
      impl Release for String { fn release(x: String) -> String { return ""; } }
    """,
  });
  fs.push(ld.SourceFile {
    path: "src/std/string/string.vox",
    text: "pub fn release(s: String) -> String { return Release.release(s); }",
  });
  fs.push(ld.SourceFile {
    path: "src/main.vox",
    text: """
      import "std/string" as s
      fn main() -> i32 {
        let mut a: String = "x";
        let _b: String = { let t: String = s.release(a); t };
        return a.len();
      }
    """,
  });

  let r: c.CompileResult = c.compile_files_to_c(fs, cg.EmitOptions {
    emit_driver_main: true,
    driver_main_kind: cg.DriverMainKind.User,
    emit_test_main: false,
    test_funcs: Vec(),
  });
  t.assert(!r.ok);
  t.assert_with(contains(r.err, "use of moved value: a"), r.err);
}
