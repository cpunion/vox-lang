import "std/testing" as t
import "vox/manifest" as m

fn test_manifest_parse_deps_path() -> () {
  let src: String = """
    [package]
    name = "app"

    [dependencies]
    foo = { path = "../foo" }
  """;
  let r: m.ParseResult = m.parse(src);
  t.assert(r.ok);
  t.assert_eq(r.m.pkg_name, "app");
  t.assert_eq(r.m.deps.len(), 1);
  let d: m.Dependency = r.m.deps.get(0);
  t.assert_eq(d.name, "foo");
  t.assert_eq(d.path, "../foo");
  t.assert(d.has_path);
  t.assert(!d.has_git);
  t.assert(!d.has_registry);
  t.assert(!d.has_version);
}

fn test_manifest_parse_deps_version_string() -> () {
  let src: String = """
    [package]
    name = "app"

    [dependencies]
    foo = "1.2.3"
  """;
  let r: m.ParseResult = m.parse(src);
  t.assert(r.ok);
  t.assert_eq(r.m.deps.len(), 1);
  let d: m.Dependency = r.m.deps.get(0);
  t.assert_eq(d.name, "foo");
  t.assert(!d.has_path);
  t.assert(!d.has_git);
  t.assert(!d.has_registry);
  t.assert(d.has_version);
  t.assert_eq(d.version, "1.2.3");
}

fn test_manifest_parse_deps_inline_path_and_version() -> () {
  let src: String = """
    [package]
    name = "app"

    [dependencies]
    foo = { path = "../foo", version = "0.2" }
  """;
  let r: m.ParseResult = m.parse(src);
  t.assert(r.ok);
  t.assert_eq(r.m.deps.len(), 1);
  let d: m.Dependency = r.m.deps.get(0);
  t.assert(d.has_path);
  t.assert_eq(d.path, "../foo");
  t.assert(!d.has_git);
  t.assert(!d.has_registry);
  t.assert(d.has_version);
  t.assert_eq(d.version, "0.2");
}

fn test_manifest_parse_deps_inline_git_rev_and_version() -> () {
  let src: String = """
    [package]
    name = "app"

    [dependencies]
    foo = { git = "https://example.com/foo.git", rev = "abc123", version = "0.2" }
  """;
  let r: m.ParseResult = m.parse(src);
  t.assert(r.ok);
  t.assert_eq(r.m.deps.len(), 1);
  let d: m.Dependency = r.m.deps.get(0);
  t.assert(!d.has_path);
  t.assert(d.has_git);
  t.assert_eq(d.git, "https://example.com/foo.git");
  t.assert(d.has_rev);
  t.assert_eq(d.rev, "abc123");
  t.assert(d.has_version);
  t.assert_eq(d.version, "0.2");
}

fn test_manifest_parse_deps_inline_registry_version() -> () {
  let src: String = """
    [package]
    name = "app"

    [dependencies]
    foo = { registry = "../registry", version = "1.2.3" }
  """;
  let r: m.ParseResult = m.parse(src);
  t.assert(r.ok);
  t.assert_eq(r.m.deps.len(), 1);
  let d: m.Dependency = r.m.deps.get(0);
  t.assert(!d.has_path);
  t.assert(!d.has_git);
  t.assert(d.has_registry);
  t.assert_eq(d.registry, "../registry");
  t.assert(d.has_version);
  t.assert_eq(d.version, "1.2.3");
}

fn test_manifest_parse_dep_unknown_field_rejected() -> () {
  let src: String = """
    [package]
    name = "app"

    [dependencies]
    foo = { nope = "x" }
  """;
  let r: m.ParseResult = m.parse(src);
  t.assert(!r.ok);
}
