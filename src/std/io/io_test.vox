import "std/io" as io
import "std/runtime" as rt
import "std/testing" as t

fn tmp_file_path(prefix: String) -> String {
  io.mkdir_p("target/tmp");
  return "target/tmp/"
    .concat(prefix)
    .concat("_")
    .concat(rt.now_ns().to_string())
    .concat(".txt");
}

fn test_io_file_oop_api_smoke() -> () {
  let path: String = tmp_file_path("io_oop");
  let f: io.File = io.file(path);
  f.write_all("hello");
  t.assert(f.exists());
  t.assert_eq(f.read_all(), "hello");
}

fn test_io_file_free_function_compat_smoke() -> () {
  let path: String = tmp_file_path("io_compat");
  let f_write: io.File = io.file(path);
  io.file_write_all(f_write, "x");
  t.assert(io.file_exists(path));
  let f_read: io.File = io.file(path);
  t.assert_eq(io.file_read_all(f_read), "x");
  let dir: io.File = io.file(path.concat(".dir"));
  dir.mkdir_p();
}

fn test_io_net_closed_conn_checked_api_smoke() -> () {
  let mut c0: io.NetConn = io.closed_conn();
  t.assert(io.net_is_closed(c0));

  let s0: io.NetI32Result = io.net_try_send(c0, "x");
  t.assert(!s0.ok);
  t.assert_eq(s0.err, "net conn is closed");

  let r0: io.NetStringResult = io.net_try_recv(c0, 8);
  t.assert(!r0.ok);
  t.assert_eq(r0.err, "net conn is closed");

  let rd: io.NetBoolResult = io.net_try_wait_read(c0, 1);
  t.assert(!rd.ok);
  t.assert_eq(rd.err, "net conn is closed");

  let wr: io.NetBoolResult = io.net_try_wait_write(c0, 1);
  t.assert(!wr.ok);
  t.assert_eq(wr.err, "net conn is closed");

  let c1r: io.NetCloseResult = io.net_try_close(c0);
  t.assert(c1r.ok);
  t.assert(!c1r.closed_now);
  c0 = c1r.conn;
  t.assert(io.net_is_closed(c0));

  let c2: io.NetConn = io.net_close(c0);
  t.assert(io.net_is_closed(c2));
}

fn test_io_net_closed_conn_method_style_smoke() -> () {
  let c0: io.NetConn = io.closed_conn();
  t.assert(c0.is_closed());

  let s0: io.NetI32Result = c0.try_send("x");
  t.assert(!s0.ok);
  t.assert_eq(s0.err, "net conn is closed");

  let r0: io.NetStringResult = c0.try_recv(4);
  t.assert(!r0.ok);
  t.assert_eq(r0.err, "net conn is closed");

  let c1r: io.NetCloseResult = c0.try_close();
  t.assert(c1r.ok);
  t.assert(!c1r.closed_now);

  let c2: io.NetConn = c1r.conn.close();
  t.assert(c2.is_closed());
}
