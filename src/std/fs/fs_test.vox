import "std/fs" as fs
import "std/runtime" as rt
import "std/testing" as t

fn tmp_dir(prefix: String) -> String {
  let base: String = "target/tmp/"
    .concat(prefix)
    .concat("_")
    .concat(rt.now_ns().to_string());
  fs.mkdir_p(base);
  return base;
}

fn test_fs_path_oop_api_smoke() -> () {
  let dir_raw: String = tmp_dir("std_fs_oop");
  let dir: fs.Path = fs.path(dir_raw);
  let file_raw: String = dir_raw.concat("/a.vox");
  let f: fs.Path = fs.path(file_raw);
  f.write_string("fn main() -> i32 { return 0; }\n");
  t.assert_with(f.exists(), "path.exists false after write");
  let got: String = f.read_to_string();
  t.assert_with(got == "fn main() -> i32 { return 0; }\n", got);
  let _xs: Vec[String] = dir.walk_files();
}

fn test_fs_free_function_compat_smoke() -> () {
  let dir_raw: String = tmp_dir("std_fs_compat");
  let file_raw: String = dir_raw.concat("/b.vox");
  fs.write_string(file_raw, "fn main() -> i32 { return 1; }\n");
  t.assert_with(fs.exists(file_raw), "fs.exists false after write");
  let got: String = fs.read_to_string(file_raw);
  t.assert_with(got == "fn main() -> i32 { return 1; }\n", got);
  let _xs: Vec[String] = fs.walk_files(dir_raw);
}

fn test_fs_memfs_virtual_fs_smoke() -> () {
  let mut m: fs.MemFS = fs.mem_fs();
  m = m.mkdir_p("/src");
  m = m.write_string("/src/a.vox", "fn main() -> i32 { return 2; }\n");
  t.assert(m.exists("/src"));
  t.assert(m.exists("/src/a.vox"));
  t.assert_eq(m.read_to_string("/src/a.vox"), "fn main() -> i32 { return 2; }\n");

  let xs: Vec[String] = m.walk_files("/src");
  t.assert_eq(xs.len(), 1);
  t.assert_eq(xs.get(0), "/src/a.vox");
}

fn test_fs_virtual_fs_generic_helpers_smoke() -> () {
  let mut m: fs.MemFS = fs.mem_fs();
  m = fs.fs_mkdir_p(m, "/pkg");
  m = fs.fs_write_string(m, "/pkg/lib.vox", "fn lib() -> i32 { return 1; }\n");
  t.assert(fs.fs_exists(m, "/pkg/lib.vox"));
  t.assert_eq(fs.fs_read_to_string(m, "/pkg/lib.vox"), "fn lib() -> i32 { return 1; }\n");
  let xs: Vec[String] = fs.fs_walk_files(m, "/pkg");
  t.assert_eq(xs.len(), 1);
}
