import "openai" as openai

pub struct ProviderSpec {
  pub provider: String,
  pub model: String,
}

fn ascii_lower(raw: String) -> String {
  let lowers: String = "abcdefghijklmnopqrstuvwxyz";
  let mut out: String = "";
  let mut i: i32 = 0;
  while i < raw.len() {
    let ch: i32 = raw.byte_at(i);
    if ch >= 65 && ch <= 90 {
      out = out.concat(lowers.slice(ch - 65, ch - 64));
    } else {
      out = out.concat(raw.slice(i, i + 1));
    }
    i = i + 1;
  }
  return out;
}

fn trim_ws(raw: String) -> String {
  let mut lo: i32 = 0;
  while lo < raw.len() {
    let ch: i32 = raw.byte_at(lo);
    if ch == 32 || ch == 9 || ch == 10 || ch == 13 {
      lo = lo + 1;
    } else {
      break;
    }
  }
  if lo >= raw.len() { return ""; }

  let mut hi: i32 = raw.len();
  while hi > lo {
    let ch: i32 = raw.byte_at(hi - 1);
    if ch == 32 || ch == 9 || ch == 10 || ch == 13 {
      hi = hi - 1;
    } else {
      break;
    }
  }
  return raw.slice(lo, hi);
}

pub fn default_model(provider0: String) -> String {
  let provider: String = ascii_lower(trim_ws(provider0));
  if provider == "openai" { return openai.default_model(); }
  return openai.default_model();
}

pub fn is_supported(provider0: String) -> bool {
  let provider: String = ascii_lower(trim_ws(provider0));
  return provider == "openai";
}

pub fn parse(spec0: String) -> ProviderSpec {
  let spec: String = trim_ws(spec0);
  if spec == "" {
    return ProviderSpec { provider: "openai", model: openai.default_model() };
  }

  let mut at: i32 = -1;
  let mut i: i32 = 0;
  while i < spec.len() {
    if spec.byte_at(i) == 58 {
      at = i;
      i = spec.len();
    } else {
      i = i + 1;
    }
  }

  if at < 0 {
    return ProviderSpec {
      provider: "openai",
      model: trim_ws(spec),
    };
  }

  let mut provider: String = ascii_lower(trim_ws(spec.slice(0, at)));
  let mut model: String = trim_ws(spec.slice(at + 1, spec.len()));
  if provider == "" { provider = "openai"; }
  if model == "" { model = default_model(provider); }
  return ProviderSpec { provider: provider, model: model };
}
