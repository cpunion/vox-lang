name: ci-release

on:
  pull_request:
    branches:
      - main
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  fmt-check:
    name: fmt-check
    runs-on: ubuntu-latest
    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: Prepare locked bootstrap compiler
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/release/prepare-locked-bootstrap.sh "${GITHUB_REPOSITORY}" "linux-amd64"

      - name: Run fmt check
        shell: bash
        run: |
          set -euo pipefail
          make fmt-check

  build:
    name: build-and-smoke-${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    needs: fmt-check
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-amd64
          - os: macos-14
            platform: darwin-arm64

    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: Install C compiler (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install mingw -y --no-progress
          Add-Content -Path $env:GITHUB_PATH -Value 'C:\ProgramData\mingw64\mingw64\bin'
          Add-Content -Path $env:GITHUB_PATH -Value 'C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin'

      - name: Compute build metadata
        shell: bash
        run: |
          set -euo pipefail
          plat="${{ matrix.platform }}"
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == refs/tags/* ]]; then
            ver="${GITHUB_REF_NAME}"
          else
            ver="pr-${GITHUB_SHA::7}"
          fi
          echo "PLATFORM=${plat}" >> "$GITHUB_ENV"
          echo "BUILD_VERSION=${ver}" >> "$GITHUB_ENV"

      - name: Verify runner host matches platform
        shell: bash
        run: |
          set -euo pipefail
          host_os="$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')"
          host_arch="$(echo "${RUNNER_ARCH}" | tr '[:upper:]' '[:lower:]')"
          case "$host_arch" in
            x64|amd64) host_arch="amd64" ;;
            arm64) host_arch="arm64" ;;
            x86|386) host_arch="x86" ;;
          esac
          expected_os="${PLATFORM%%-*}"
          expected_arch="${PLATFORM#*-}"
          if [[ "$host_os" != "$expected_os" || "$host_arch" != "$expected_arch" ]]; then
            echo "runner host mismatch: host=${host_os}-${host_arch} expected=${PLATFORM}" >&2
            exit 1
          fi

      - name: Prepare locked bootstrap compiler
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/release/prepare-locked-bootstrap.sh "${GITHUB_REPOSITORY}" "${PLATFORM}"

      - name: Build release bundle
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/build-release-bundle.sh "${BUILD_VERSION}" "${PLATFORM}"

      - name: Run smoke tests (rolling bootstrap)
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/smoke-toolchains.sh

      - name: Run syntax acceptance tests
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/ci/test-syntax.sh

      - name: Validate --target host build/test
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          COMPILER_BIN="target/release/vox"
          if [[ "${RUNNER_OS}" == "Windows" ]]; then
            COMPILER_BIN="target/release/vox.exe"
          fi
          if [[ ! -f "$COMPILER_BIN" ]]; then
            echo "compiler not found: $COMPILER_BIN"
            exit 1
          fi

          target="${PLATFORM}"
          "$COMPILER_BIN" build "--target=${target}" target/debug/vox.target_host
          "$COMPILER_BIN" test "--target=${target}" "--run=*std_sync_runtime_generic_api_smoke" target/debug/vox.target_host.test

      - name: Validate --target regression
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          COMPILER_BIN="target/release/vox"
          if [[ "${RUNNER_OS}" == "Windows" ]]; then
            COMPILER_BIN="target/release/vox.exe"
          fi
          if [[ ! -f "$COMPILER_BIN" ]]; then
            echo "compiler not found: $COMPILER_BIN"
            exit 1
          fi
          "$COMPILER_BIN" test "--run=*target_matrix_*" target/debug/vox.target_matrix.test

      - name: Verify release bundle manifest
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/verify-release-bundle.sh "${BUILD_VERSION}" "${PLATFORM}"

      - name: Upload platform artifacts
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: bundle-${{ env.PLATFORM }}
          path: |
            dist/vox-lang-${{ env.BUILD_VERSION }}-${{ env.PLATFORM }}.tar.gz
            dist/vox-lang-${{ env.BUILD_VERSION }}-${{ env.PLATFORM }}.tar.gz.sha256

  build-windows:
    name: build-and-smoke-windows-amd64-${{ matrix.gate }}
    runs-on: windows-latest
    needs: fmt-check
    strategy:
      fail-fast: false
      matrix:
        gate: [host, regression]

    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
      PLATFORM: windows-amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: Setup MSVC toolchain (PR fast path)
        if: github.event_name == 'pull_request'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Use MSVC compiler on PR
        if: github.event_name == 'pull_request'
        shell: bash
        run: |
          set -euo pipefail
          echo "CC=cl" >> "$GITHUB_ENV"

      - name: Install C compiler (Windows release path)
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        shell: powershell
        run: |
          choco install mingw -y --no-progress
          Add-Content -Path $env:GITHUB_PATH -Value 'C:\ProgramData\mingw64\mingw64\bin'
          Add-Content -Path $env:GITHUB_PATH -Value 'C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin'

      - name: Compute build metadata
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == refs/tags/* ]]; then
            ver="${GITHUB_REF_NAME}"
          else
            ver="pr-${GITHUB_SHA::7}"
          fi
          echo "BUILD_VERSION=${ver}" >> "$GITHUB_ENV"

      - name: Verify runner host matches platform
        shell: bash
        run: |
          set -euo pipefail
          host_os="$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')"
          host_arch="$(echo "${RUNNER_ARCH}" | tr '[:upper:]' '[:lower:]')"
          case "$host_arch" in
            x64|amd64) host_arch="amd64" ;;
            arm64) host_arch="arm64" ;;
            x86|386) host_arch="x86" ;;
          esac
          expected_os="${PLATFORM%%-*}"
          expected_arch="${PLATFORM#*-}"
          if [[ "$host_os" != "$expected_os" || "$host_arch" != "$expected_arch" ]]; then
            echo "runner host mismatch: host=${host_os}-${host_arch} expected=${PLATFORM}" >&2
            exit 1
          fi

      - name: Prepare locked bootstrap compiler
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/release/prepare-locked-bootstrap.sh "${GITHUB_REPOSITORY}" "${PLATFORM}"

      - name: Build release bundle
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/build-release-bundle.sh "${BUILD_VERSION}" "${PLATFORM}"

      - name: Run smoke tests (rolling bootstrap)
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/smoke-toolchains.sh

      - name: Validate --target host build/test
        if: matrix.gate == 'host'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          COMPILER_BIN="target/release/vox.exe"
          if [[ ! -f "$COMPILER_BIN" ]]; then
            echo "compiler not found: $COMPILER_BIN"
            exit 1
          fi

          target="${PLATFORM}"
          "$COMPILER_BIN" build "--target=${target}" target/debug/vox.target_host
          "$COMPILER_BIN" test "--target=${target}" "--run=*std_sync_runtime_generic_api_smoke" target/debug/vox.target_host.test

      - name: Validate --target regression
        if: matrix.gate == 'regression'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          COMPILER_BIN="target/release/vox.exe"
          if [[ ! -f "$COMPILER_BIN" ]]; then
            echo "compiler not found: $COMPILER_BIN"
            exit 1
          fi
          "$COMPILER_BIN" test "--run=*target_matrix_*" target/debug/vox.target_matrix.test

      - name: Verify release bundle manifest
        if: matrix.gate == 'host'
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/verify-release-bundle.sh "${BUILD_VERSION}" "${PLATFORM}"

      - name: Upload platform artifacts
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') && matrix.gate == 'host'
        uses: actions/upload-artifact@v4
        with:
          name: bundle-${{ env.PLATFORM }}
          path: |
            dist/vox-lang-${{ env.BUILD_VERSION }}-${{ env.PLATFORM }}.tar.gz
            dist/vox-lang-${{ env.BUILD_VERSION }}-${{ env.PLATFORM }}.tar.gz.sha256

  build-cross-x86:
    name: build-cross-x86
    runs-on: ubuntu-latest
    needs: fmt-check
    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: Install cross C toolchains
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y gcc-i686-linux-gnu gcc-mingw-w64-i686

      - name: Compute build metadata
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == refs/tags/* ]]; then
            ver="${GITHUB_REF_NAME}"
          else
            ver="pr-${GITHUB_SHA::7}"
          fi
          echo "BUILD_VERSION=${ver}" >> "$GITHUB_ENV"

      - name: Prepare locked bootstrap compiler
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/release/prepare-locked-bootstrap.sh "${GITHUB_REPOSITORY}" "linux-amd64"

      - name: Build host rolling compiler for cross gate
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          ./scripts/ci/rolling-selfhost.sh build

      - name: Validate cross target build
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          COMPILER_BIN="target/debug/vox_rolling"
          "$COMPILER_BIN" build --target=linux-x86 target/debug/vox.cross_linux_x86
          "$COMPILER_BIN" build --target=windows-x86 target/debug/vox.cross_windows_x86

      - name: Build x86 release bundles
        shell: bash
        run: |
          set -euo pipefail
          VOX_BOOTSTRAP=target/debug/vox_rolling ./scripts/release/build-release-bundle.sh "${BUILD_VERSION}" "linux-x86"
          VOX_BOOTSTRAP=target/debug/vox_rolling ./scripts/release/build-release-bundle.sh "${BUILD_VERSION}" "windows-x86"

      - name: Verify x86 release bundles
        shell: bash
        run: |
          set -euo pipefail
          VOX_VERIFY_EXEC=0 ./scripts/release/verify-release-bundle.sh "${BUILD_VERSION}" "linux-x86"
          VOX_VERIFY_EXEC=0 ./scripts/release/verify-release-bundle.sh "${BUILD_VERSION}" "windows-x86"

      - name: Upload x86 artifacts
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: bundle-x86
          path: |
            dist/vox-lang-${{ env.BUILD_VERSION }}-linux-x86.tar.gz
            dist/vox-lang-${{ env.BUILD_VERSION }}-linux-x86.tar.gz.sha256
            dist/vox-lang-${{ env.BUILD_VERSION }}-windows-x86.tar.gz
            dist/vox-lang-${{ env.BUILD_VERSION }}-windows-x86.tar.gz.sha256


  smoke-wasm-node:
    name: smoke-wasm-node
    runs-on: ubuntu-latest
    needs: fmt-check
    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
      VOX_WASM_WEB_PORT: "18080"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22.x"
          cache: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Emscripten toolchain
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y emscripten

      - name: Prepare locked bootstrap compiler
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/release/prepare-locked-bootstrap.sh "${GITHUB_REPOSITORY}" "linux-amd64"

      - name: Build rolling compiler
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/ci/rolling-selfhost.sh build

      - name: Smoke wasm Node/Web example
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/ci/smoke-wasm-node.sh target/debug/vox_rolling
  publish:
    name: publish-release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [build, build-windows, build-cross-x86, smoke-wasm-node]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: bundle-*
          merge-multiple: true

      - name: Build source bundle
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/build-source-bundle.sh "${GITHUB_REF_NAME}"

      - name: Verify source bundle
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/verify-source-bundle.sh "${GITHUB_REF_NAME}"

      - name: Aggregate checksums
        shell: bash
        run: |
          set -euo pipefail
          cat dist/*.sha256 > dist/SHA256SUMS

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/*.sha256
            dist/SHA256SUMS
