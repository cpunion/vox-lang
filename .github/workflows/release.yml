name: ci-release

on:
  pull_request:
    branches:
      - main
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  builtin-freeze-check:
    name: builtin-freeze-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify frozen builtin/intrinsic set
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/ci/check-frozen-builtins.sh

  build-style-check:
    name: build-style-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify @build/@cfg style policy
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/ci/check-no-cfg-in-code.sh

  runtime-alias-check:
    name: runtime-alias-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify runtime alias surface policy
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/ci/check-no-vox-rt-in-src.sh
          ./scripts/ci/check-no-vox-builtin-in-src.sh
          ./scripts/ci/check-no-vox-ffi-outside-runtime.sh

  fmt-check:
    name: fmt-check
    runs-on: ubuntu-latest
    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare locked bootstrap compiler
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/release/prepare-locked-bootstrap.sh "${GITHUB_REPOSITORY}" "linux-amd64"

      - name: Run fmt check
        shell: bash
        run: |
          set -euo pipefail
          make fmt-check

  build:
    name: build-and-smoke-${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux-amd64
          - os: macos-14
            platform: darwin-arm64

    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install C compiler (Windows)
        if: runner.os == 'Windows'
        shell: powershell
        run: |
          choco install mingw -y --no-progress
          Add-Content -Path $env:GITHUB_PATH -Value 'C:\ProgramData\mingw64\mingw64\bin'
          Add-Content -Path $env:GITHUB_PATH -Value 'C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin'

      - name: Compute build metadata
        shell: bash
        run: |
          set -euo pipefail
          plat="${{ matrix.platform }}"
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == refs/tags/* ]]; then
            ver="${GITHUB_REF_NAME}"
          else
            ver="pr-${GITHUB_SHA::7}"
          fi
          echo "PLATFORM=${plat}" >> "$GITHUB_ENV"
          echo "BUILD_VERSION=${ver}" >> "$GITHUB_ENV"

      - name: Verify runner host matches platform
        shell: bash
        run: |
          set -euo pipefail
          host_os="$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')"
          if [[ "$host_os" == "macos" ]]; then host_os="darwin"; fi
          host_arch="$(echo "${RUNNER_ARCH}" | tr '[:upper:]' '[:lower:]')"
          case "$host_arch" in
            x64|amd64) host_arch="amd64" ;;
            arm64) host_arch="arm64" ;;
            x86|386) host_arch="x86" ;;
          esac
          expected_os="${PLATFORM%%-*}"
          expected_arch="${PLATFORM#*-}"
          if [[ "$host_os" != "$expected_os" || "$host_arch" != "$expected_arch" ]]; then
            echo "runner host mismatch: host=${host_os}-${host_arch} expected=${PLATFORM}" >&2
            exit 1
          fi

      - name: Prepare locked bootstrap compiler
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/release/prepare-locked-bootstrap.sh "${GITHUB_REPOSITORY}" "${PLATFORM}"

      - name: Build release bundle
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/build-release-bundle.sh "${BUILD_VERSION}" "${PLATFORM}"

      - name: Run smoke tests (rolling bootstrap)
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/smoke-toolchains.sh

      - name: Run syntax acceptance tests
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/ci/test-syntax.sh

      - name: Validate --target host build/test
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          COMPILER_BIN="target/release/vox"
          if [[ "${RUNNER_OS}" == "Windows" ]]; then
            COMPILER_BIN="target/release/vox.exe"
          fi
          if [[ ! -f "$COMPILER_BIN" ]]; then
            echo "compiler not found: $COMPILER_BIN"
            exit 1
          fi

          target="${PLATFORM}"
          "$COMPILER_BIN" build "--target=${target}" target/debug/vox.target_host
          "$COMPILER_BIN" test "--target=${target}" "--run=*std_sync_runtime_generic_api_smoke" target/debug/vox.target_host.test

      - name: Validate --target regression
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          COMPILER_BIN="target/release/vox"
          if [[ "${RUNNER_OS}" == "Windows" ]]; then
            COMPILER_BIN="target/release/vox.exe"
          fi
          if [[ ! -f "$COMPILER_BIN" ]]; then
            echo "compiler not found: $COMPILER_BIN"
            exit 1
          fi
          "$COMPILER_BIN" test "--run=*target_matrix_*" target/debug/vox.target_matrix.test

      - name: Verify release bundle manifest
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/verify-release-bundle.sh "${BUILD_VERSION}" "${PLATFORM}"

      - name: Upload platform artifacts
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: bundle-${{ env.PLATFORM }}
          path: |
            dist/vox-lang-${{ env.BUILD_VERSION }}-${{ env.PLATFORM }}.tar.gz
            dist/vox-lang-${{ env.BUILD_VERSION }}-${{ env.PLATFORM }}.tar.gz.sha256

  build-windows:
    name: build-and-smoke-windows-amd64
    runs-on: windows-latest

    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
      VOX_PLATFORM: windows-amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install C compiler (Windows)
        shell: powershell
        run: |
          $gcc = Get-Command gcc -ErrorAction SilentlyContinue
          if ($gcc) {
            Write-Host "[ci] gcc already present: $($gcc.Path)"
          } else {
            Write-Host "[ci] gcc not found; installing MinGW via chocolatey"
            choco install mingw -y --no-progress
          }
          $cand = @(
            'C:\mingw64\bin',
            'C:\ProgramData\mingw64\mingw64\bin',
            'C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin'
          )
          foreach ($p in $cand) {
            if (Test-Path $p) {
              Add-Content -Path $env:GITHUB_PATH -Value $p
            }
          }
          $gcc2 = Get-Command gcc -ErrorAction SilentlyContinue
          if (-not $gcc2) { throw "gcc not found after setup" }
          gcc --version | Select-Object -First 1

      - name: Use MinGW compiler on Windows
        shell: bash
        run: |
          set -euo pipefail
          cc_path="$(command -v gcc)"
          if [[ -z "$cc_path" ]]; then
            echo "gcc not found in PATH" >&2
            exit 1
          fi
          if command -v cygpath >/dev/null 2>&1; then
            cc_path_win="$(cygpath -w "$cc_path" 2>/dev/null || true)"
            if [[ -n "$cc_path_win" ]]; then
              cc_path="$cc_path_win"
            fi
          fi
          echo "CC=$cc_path" >> "$GITHUB_ENV"
          echo "[ci] using CC=$cc_path"
          gcc --version | head -n 1

      - name: Compute build metadata
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == refs/tags/* ]]; then
            ver="${GITHUB_REF_NAME}"
          else
            ver="pr-${GITHUB_SHA::7}"
          fi
          echo "BUILD_VERSION=${ver}" >> "$GITHUB_ENV"

      - name: Verify runner host matches platform
        shell: bash
        run: |
          set -euo pipefail
          host_os="$(echo "${RUNNER_OS}" | tr '[:upper:]' '[:lower:]')"
          if [[ "$host_os" == "macos" ]]; then host_os="darwin"; fi
          host_arch="$(echo "${RUNNER_ARCH}" | tr '[:upper:]' '[:lower:]')"
          case "$host_arch" in
            x64|amd64) host_arch="amd64" ;;
            arm64) host_arch="arm64" ;;
            x86|386) host_arch="x86" ;;
          esac
          expected_os="${VOX_PLATFORM%%-*}"
          expected_arch="${VOX_PLATFORM#*-}"
          if [[ "$host_os" != "$expected_os" || "$host_arch" != "$expected_arch" ]]; then
            echo "runner host mismatch: host=${host_os}-${host_arch} expected=${VOX_PLATFORM}" >&2
            exit 1
          fi

      - name: Prepare locked bootstrap compiler
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/release/prepare-locked-bootstrap.sh "${GITHUB_REPOSITORY}" "${VOX_PLATFORM}"

      - name: Build release bundle
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/build-release-bundle.sh "${BUILD_VERSION}" "${VOX_PLATFORM}"

      - name: Run smoke tests (rolling bootstrap)
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/smoke-toolchains.sh

      - name: Verify release bundle manifest
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/verify-release-bundle.sh "${BUILD_VERSION}" "${VOX_PLATFORM}"

      - name: Upload platform artifacts
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: bundle-${{ env.VOX_PLATFORM }}
          path: |
            dist/vox-lang-${{ env.BUILD_VERSION }}-${{ env.VOX_PLATFORM }}.tar.gz
            dist/vox-lang-${{ env.BUILD_VERSION }}-${{ env.VOX_PLATFORM }}.tar.gz.sha256

      - name: Upload Windows compiler for downstream gates
        uses: actions/upload-artifact@v4
        with:
          name: windows-compiler
          path: |
            target/release/vox.exe

  windows-host-gate:
    name: windows-target-host-gate
    runs-on: windows-latest
    needs: build-windows
    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
      VOX_PLATFORM: windows-amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install C compiler (Windows)
        shell: powershell
        run: |
          $gcc = Get-Command gcc -ErrorAction SilentlyContinue
          if ($gcc) {
            Write-Host "[ci] gcc already present: $($gcc.Path)"
          } else {
            Write-Host "[ci] gcc not found; installing MinGW via chocolatey"
            choco install mingw -y --no-progress
          }
          $cand = @(
            'C:\mingw64\bin',
            'C:\ProgramData\mingw64\mingw64\bin',
            'C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin'
          )
          foreach ($p in $cand) {
            if (Test-Path $p) {
              Add-Content -Path $env:GITHUB_PATH -Value $p
            }
          }
          $gcc2 = Get-Command gcc -ErrorAction SilentlyContinue
          if (-not $gcc2) { throw "gcc not found after setup" }
          gcc --version | Select-Object -First 1

      - name: Use MinGW compiler on Windows
        shell: bash
        run: |
          set -euo pipefail
          cc_path="$(command -v gcc)"
          if [[ -z "$cc_path" ]]; then
            echo "gcc not found in PATH" >&2
            exit 1
          fi
          if command -v cygpath >/dev/null 2>&1; then
            cc_path_win="$(cygpath -w "$cc_path" 2>/dev/null || true)"
            if [[ -n "$cc_path_win" ]]; then
              cc_path="$cc_path_win"
            fi
          fi
          echo "CC=$cc_path" >> "$GITHUB_ENV"
          echo "[ci] using CC=$cc_path"
          gcc --version | head -n 1

      - name: Download compiler artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-compiler
          path: target/release

      - name: Validate --target host build/test
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          COMPILER_BIN="target/release/vox.exe"
          if [[ ! -f "$COMPILER_BIN" ]]; then
            echo "compiler not found: $COMPILER_BIN"
            exit 1
          fi
          target="${VOX_PLATFORM}"
          "$COMPILER_BIN" build "--target=${target}" target/debug/vox.target_host
          "$COMPILER_BIN" test "--target=${target}" "--run=*std_sync_runtime_generic_api_smoke" target/debug/vox.target_host.test

  windows-regression-gate:
    name: windows-target-regression-gate
    runs-on: windows-latest
    needs: build-windows
    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download compiler artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-compiler
          path: target/release

      - name: Validate --target regression
        shell: bash
        env:
          CC: ""
        run: |
          set -euo pipefail
          mkdir -p target/debug
          COMPILER_BIN="target/release/vox.exe"
          if [[ ! -f "$COMPILER_BIN" ]]; then
            echo "compiler not found: $COMPILER_BIN"
            exit 1
          fi
          "$COMPILER_BIN" test "--run=*target_matrix_*" target/debug/vox.target_matrix.test

  build-cross-x86:
    name: build-cross-x86
    runs-on: ubuntu-latest
    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install cross C toolchains
        shell: bash
        run: |
          set -euo pipefail
          # Use a faster mirror to avoid Azure apt mirror timeouts.
          sudo sed -i 's|http://azure.archive.ubuntu.com/ubuntu|http://archive.ubuntu.com/ubuntu|g' /etc/apt/sources.list /etc/apt/sources.list.d/*.list 2>/dev/null || true
          sudo apt-get update -o Acquire::Retries=3
          sudo apt-get install -y -o Acquire::Retries=3 gcc-i686-linux-gnu gcc-mingw-w64-i686

      - name: Compute build metadata
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "push" && "${GITHUB_REF}" == refs/tags/* ]]; then
            ver="${GITHUB_REF_NAME}"
          else
            ver="pr-${GITHUB_SHA::7}"
          fi
          echo "BUILD_VERSION=${ver}" >> "$GITHUB_ENV"

      - name: Prepare locked bootstrap compiler
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/release/prepare-locked-bootstrap.sh "${GITHUB_REPOSITORY}" "linux-amd64"

      - name: Build host rolling compiler for cross gate
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          ./scripts/ci/rolling-selfhost.sh build

      - name: Validate cross target build
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p target/debug
          COMPILER_BIN="target/debug/vox_rolling"
          "$COMPILER_BIN" build --target=linux-x86 target/debug/vox.cross_linux_x86
          "$COMPILER_BIN" build --target=windows-x86 target/debug/vox.cross_windows_x86

      - name: Build x86 release bundles
        shell: bash
        run: |
          set -euo pipefail
          VOX_BOOTSTRAP=target/debug/vox_rolling ./scripts/release/build-release-bundle.sh "${BUILD_VERSION}" "linux-x86"
          VOX_BOOTSTRAP=target/debug/vox_rolling ./scripts/release/build-release-bundle.sh "${BUILD_VERSION}" "windows-x86"

      - name: Verify x86 release bundles
        shell: bash
        run: |
          set -euo pipefail
          VOX_VERIFY_EXEC=0 ./scripts/release/verify-release-bundle.sh "${BUILD_VERSION}" "linux-x86"
          VOX_VERIFY_EXEC=0 ./scripts/release/verify-release-bundle.sh "${BUILD_VERSION}" "windows-x86"

      - name: Upload x86 artifacts
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
        uses: actions/upload-artifact@v4
        with:
          name: bundle-x86
          path: |
            dist/vox-lang-${{ env.BUILD_VERSION }}-linux-x86.tar.gz
            dist/vox-lang-${{ env.BUILD_VERSION }}-linux-x86.tar.gz.sha256
            dist/vox-lang-${{ env.BUILD_VERSION }}-windows-x86.tar.gz
            dist/vox-lang-${{ env.BUILD_VERSION }}-windows-x86.tar.gz.sha256


  smoke-wasm-node:
    name: smoke-wasm-node
    runs-on: ubuntu-latest
    env:
      VOX_REQUIRE_ROLLING_BOOTSTRAP: "1"
      VOX_WASM_WEB_PORT: "18080"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Emscripten toolchain
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y emscripten

      - name: Prepare locked bootstrap compiler
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          ./scripts/release/prepare-locked-bootstrap.sh "${GITHUB_REPOSITORY}" "linux-amd64"

      - name: Build rolling compiler
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/ci/rolling-selfhost.sh build

      - name: Smoke wasm Node/Web example
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/ci/smoke-wasm-node.sh target/debug/vox_rolling
  publish:
    name: publish-release
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    needs: [fmt-check, build, build-windows, windows-host-gate, windows-regression-gate, build-cross-x86, smoke-wasm-node]
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: bundle-*
          merge-multiple: true

      - name: Build source bundle
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/build-source-bundle.sh "${GITHUB_REF_NAME}"

      - name: Verify source bundle
        shell: bash
        run: |
          set -euo pipefail
          ./scripts/release/verify-source-bundle.sh "${GITHUB_REF_NAME}"

      - name: Aggregate checksums
        shell: bash
        run: |
          set -euo pipefail
          cat dist/*.sha256 > dist/SHA256SUMS

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/*.sha256
            dist/SHA256SUMS
